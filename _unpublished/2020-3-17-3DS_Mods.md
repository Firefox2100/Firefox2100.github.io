---
title: 3DS玩机笔记
date: 2020-3-17 11:31:26
categories:
- 3DS
tags:
- 3DS
- Proxmark3
---

## 前言

上个寒假里，我找到了之前的new 3DS LL并为它做了B9破解。之后，熟悉我的人都知道，我经常在一些平台上折腾各种功能和工具，不是为了有多实用，而是为了测试和研究新的技术。在3DS上也是如此。现在找到了一个合适的时间，我准备把我折腾的一系列过程和功能都记录下来，留作日后参考，也欢迎大家补充我没有了解到的新奇的功能。

**在这里补充说明一点，除了破解部分的教程，以下所有的说明都是针对B9破解的新大三，日版真实系统，系统版本为目前最新（11.13.0-45J）。当然有些东西是各种固件版本通用的，但是如果遇到了什么问题，请先尝试是否是自己系统的原因，尽量不要强行部署。如果遇到什么问题，欢迎与我交流。**

## 破解篇

首先说明，如果是正版机开始破解为了方便，建议先升级自己的系统至最新版本，也就是11.11.xx，这样能够省去之后的许多麻烦，反正正版机系统更新是绝对没有问题的。如果是之前的破解机，请按照对应的教程操作。

完整的教程可以查看[这里](https://3ds.hacks.guide/zh_CN/)，这是最官方（当然不是任天堂官方）的3DS破解指南。

## Homebrew工具和补丁篇

### LumaLocaleSwitcher

这个工具是用来运行区域不匹配的破解游戏的，**不能用于正版卡带**，购买正版请一定看准自己的机器的区域。只有极少数游戏需要使用这个工具，大部分情况下B9破解将自动模拟对应区域的机器进行游玩，而且许多游戏在被提取成CIA文件的时候已经去除了区域限制。目前发现的需要使用这个工具的只有任天狗狗系列，需要切换成区域TW，字体ZH。

### Checkpoint

Checkpoint是一个存档管理工具，也是现在最推荐的存档管理器。它的优点在于不像别的存档管理器一样，只能对着一串编号努力找到自己要管理的游戏，而是会加载一组生成过存档的游戏的图标，对着图标就能够很容易地找到自己的游戏。而且支持一键导入和备份，能够同时储存多个备份，也能够自定义备份的名字，可以说是功能非常全面而操作方便的工具。如果在使用的时候发现某一个游戏的存档自己找不到的话，按x切换到外部存储器即可。像怪物猎人XX这样的游戏，其存档是在内存卡中而非机体内部存储，按x之后即可显示。

### 基于Luma的简体中文补丁

## 模拟器篇

### 安装RetroArch for 3DS全能模拟器

#### RetroArch简介

RetroArch模拟器是一个由RetroArch团队开发的全能模拟器，它的特点有：

1. 能够模拟大量的平台，并且无需重复配置。需要模拟什么平台，只需将对应的内核加载到模拟器内即可，无需针对每一个需要模拟的平台专门配置。RetroArch的兼容性也相当不错，老到FC，街机，新到PSP，3DS，绝大多数都能模拟。
2. 能够兼容大量的平台。RetroArch不止能够在Windows上运行，Mac OS，Linux上也可以，甚至还有安卓和树莓派的专用版本（如果有树莓派正在吃灰的话就翻出来吧）。最重要的是，它能够在各种掌机和家用机平台上运行。PSP，PS2，PS3，Wii，WiiU，3DS，乃至Switch，大部分破解了的游戏平台都可以运行这个模拟器。当然，模拟器的能力也受限于运行的平台，比如基本不可能用3DS模拟PSP，而且平台性能越好，模拟效果越好。

#### 在3DS上安装和运行的方法

RetroArch的安装相对比较简单，首先去它的[官网](http://www.retroarch.com/)，找到3DS版本的下载，并且选择最新的cia版本。**如果你使用的不是B9破解，或者不是N3DSLL，请根据自己的情况选择适合的版本。**下载之后解压，将获得的``/retroarch``文件夹放入3DS的根目录。将卡插回3DS并启动机体，安装``/retroarch/cores``下的所有CIA文件，或者根据自己的需求安装需要的模拟器核心。最后一个文件是RetroArch的主程序，相当于一个集中管理器，非必需，但是推荐安装，因为安装之后有很多不错的功能。之后可以直接选取自己需要的核心运行，也可以从主程序里加载。运行一次主程序或者核心之后会自动更新配置文件，之后将自己需要模拟的ROM文件放在``/rom``下对应的路径就好。

### 在3DS上部署Linux系统

在3DS上使用Linux系统有两种方法，一是通过Linux for 3DS，二是通过DSLinux，一个为NDS开发的Linux系统。

#### 部署Linux for 3DS

Linux for 3DS是为原生3DS开发的一个Linux环境，使用的是Busybox+Buildroot的方式来获得Linux的指令集，也内置了Weston。这一项目基本已经停止更新，如果有兴趣的话，可以尝试继续开发这一项目。具体的介绍和发布页面在[这里](https://gbatemp.net/threads/release-linux-for-the-3ds.407187/)，而具体的编译和部署的方法在我的<a href="{{site.baseurl}}/kernel/2020/03/09/Linux_3DS/">另外一篇教程</a>中。

#### 部署DSLinux

DSLinux的部署和使用相对容易很多，因为它提供了预编译的Linux文件系统和内核，也将启动文件打包成了``.nds``的格式。可以通过烧录卡或者TWilight Menu的方式启动DSLinux，在这里只介绍通过R4卡启动的方法，因为TWilight启动并不稳定，经常导致3DS系统崩溃并强制重启。有关R4卡的详细内容请参考下文介绍。

首先先在[官网](http://www.dslinux.org/)上下载DLDI版本的DSLinux。将获得的文件解压并全部放在R4卡的Micro SD卡的根目录下。需要注意的是，**请使用Linux系统进行解压和复制的操作**，因为Windows下文件的结尾符与Linux并不相同，有的Windows解压工具也会忽略空目录，这些都会影响DSLinux的正常使用。在完成解压之后将R4卡重新装回3DS内，启动对应的入口程序进入R4菜单之后（这一步由于每个人使用的内核不一样，具体也略有不同），进入文件管理器，并且启动刚刚复制进去的``.nds``文件。之后DS模式会软重启并且加载DSLinux，DLDI版本的DSLinux能够自动登录，所以可以直接获取Shell。之后，由于这一移植系统的局限性，有些命令在这里不能使用，但是文件系统被挂载为读写，而且有WiFi芯片的驱动，可以通过各种方式来配置到自己喜欢的样子

### 在3DS上部署Windows系统

在3DS上使用Windows系统也有两种方法，一是通过RetroArch的DosBox模拟工具，二是通过WintenDos，一个为NDS开发的Windows环境。

## 辅助工具篇

### 使用Proxmark3模拟**不能实际使用的**Amiibo

**这一段教程纯粹是存档使用，能够模拟能正常使用的Amiibo的教程请看下一小节。**

Amiibo是Nintendo推出的一种带RFID芯片的手办，除了通常的收藏价值之外，还可以使用较新的Nintendo游戏机（比如3DS，WiiU和Switch）读取其中的NTAG215芯片，从而进行游戏和现实世界的联动。对于没有Amiibo但是想玩，而且不想额外花钱的人而言，可以购买空白的NTAG215卡自己制作Amiibo，也可以买一个专门的N2 Elite来模拟Amiibo。不过这两个方案都不便宜，NTAG215卡只有在被设置为只读的时候才能被Nintendo机器接受，这表示随着我们不断地需要新的Amiibo，也需要不断地买新的NTAG215白卡。而N2 Elite虽然能够重复使用，但是其售价接近40美金。不过当然，进入到RFID的领域，很少有问题是Proxmark3解决不了的。

#### 设备需求

一台需要游玩的支持Amiibo的游戏机（我用的自然是3DS），能够使用冰人固件的Proxmark3（我用的是rdv4.01，不过rdv2应该也能够使用），Linux环境。

#### 操作流程

首先能够模拟Amiibo的前提是，我们需要知道模拟什么。在[这个网站](https://nfc-bank.com/)可以找到非常全的Amiibo数据的dump，这是我们模拟Amiibo的基础。但是这个网站获得的Amiibo数据是``.bin``格式的，因为其他方法（写白卡和N2 Elite）都只接受这种格式。所以我们需要找到一种方法将其解密，并转换为Proxmark3使用的``.eml``格式。

有两种方法可以实现这一操作。首先可以使用amiitools这一工具将其解密，并且利用Proxmark3客户端自带的lua脚本转换成``.eml``格式。但是这样转换得到的``.eml``文件头并不与NTAG215匹配，数据块大小和整体大小也不匹配。这样将导致3DS不接受模拟的Amiibo，并且报错“这不是一个Amiibo”。所以我们在这里使用[samyk](https://github.com/samyk)所开发的一个[脚本](https://github.com/samyk/samytools/blob/master/mfubin2eml)。

从GitHub上获得脚本之后，需要在Linux环境下执行。使用命令是

```Shell
./mfubin2eml <Your-bin-file>.bin > amiibo.eml
```

可以很轻松地获得``.eml``文件。之后就是利用Proxmark3模拟Amiibo了。这里有一个小小的问题，就是最新版本的RFIDResearchGroup的固件，在加载这个脚本转换的``.eml``文件时，会将其认为是旧版本的NTAG243卡的数据dump，这将导致错误的加载和模拟。所以在这里我们使用旧版本的[冰人固件](https://github.com/iceman1001/proxmark3)，虽然已经标为停止维护，但是最终版本的源码是干净而且完全可以编译的。但是在Windows下的ProxSpace环境中会出现错误，所以最好在Linux环境下编译。启动Proxmark3客户端之后，运行指令

```Shell
hf mf eload u <path to>amiibo.eml
```

之后运行

```Shell
hf 14a sim t 7 u [UID]
```

其中UID号在``mfubin2eml``脚本执行完成的回显中将给出。之后Proxmark3将开始模拟Amiibo，按下上面的按键将中止模拟。此时只需在3DS要求Amiibo时将Proxmark3放在下屏幕上即可。但是Amiibo的模拟并非是完美的，目前暂时无法让3DS为模拟的Amiibo设置拥有者，这就表示模拟出来的Amiibo其实不能在游戏中使用。出现这一问题的原因是Proxmark3无法响应3DS发送的写卡指令，这样导致不能往Proxmark3模拟的Amiibo里写入拥有者的数据和游戏记录，无法实际进行游戏。

不过不推荐为了这个专门买一台Proxmark3，它是一个非常强大的工具，只做这个有些大材小用，而且本身并不便宜，甚至比一台3DS还贵很多，我是因为之前学习需要买了Proxmark3，正好在这里用到一下。

### 使用Proxmark3模拟**能正常使用**的Amiibo

这一小节的内容写在上一小节的三天后，我粗略地过了一遍Proxmark3的RRG固件和冰人固件的源码，找到了RRG固件不能模拟Amiibo的原因，但是目前还没有在RRG固件里加上，因为Proxmark3的固件源码风格太过复杂......真正能够加入开发需要很长一段时间来研究源码。我转而找到了James Chambers，前NCC小组成员，在一次大会上展示的使用原始版本Proxmark3（不是RDV4，是原来的Proxmark3团队开发的很大的开发板）来模拟Amiibo的视频。视频介绍的非常详尽，描述了怎样复现完整的过程。在James Chambers的GitHub个人主页和博客之下还可以找到大会上使用的PPT，里面也介绍了一些很详细的内容。将两者结合起来之后，我大致明白了这一原理。

小小地说一句题外话，我准备借鉴这一源码并加入RRG的固件，尝试允许Proxmark3在模拟其他的卡的时候也能正常响应写卡指令。大概需要几个月的时间来移植。唯一的问题在于，这些比较新的固件已经封装了很多驱动而没有保留一个比较中层的接口，而且名称相同的很多指令也与原来版本的Proxmark3不一样（这就是为什么我之前使用RRG固件，不管怎么操作，哪怕手动一个块一个块载入再模拟都做不到的原因，因为很多指令并不是原来的一样的效果）代表着我没有办法直接移植，不过反正固件已经开源，有足够的时间，我可以尝试自己从底层加入这个功能。

好了，说回正题。这一操作的核心就是[这个固件](https://github.com/nccgroup/proxmark3-amiimicyou)，更准确地说，是这个固件里面开发的``Amiibo.lua``脚本实现的功能，和这个固件的特殊的指令。这个脚本能够直接从``.bin``文件转换至``.eml``文件，也能够解密，和直接读取Amiibo，不过需要一个解密密钥。这一功能并不特别，特别的是NCC Group的固件，它允许Proxmark3在模拟NTAG215卡的时候，响应标准的14a协议的指令，而在使用Amiibo时，3DS只会发出读写的指令，而Proxmark3都能够响应。这样就解决了之前的问题。我下一步将尝试将这个功能和RRG的固件整合起来（等我看懂了RRG这里怎么写的就会开始）。

具体的使用方法是，先clone固件源码并执行编译，之后和其他的固件就一样了。需要注意的是，这个固件因为是很早起的版本，是基于Qt4的，而现在绝大多数工具和程序是基于Qt5的。从Qt4升级到Qt5之后，许多库的位置和内容都和之前不一样了。如果直接修改比较麻烦，我选择了重新配置Qt4环境，为了避免Qt两个版本共存对我其他程序产生影响，我重新安装了一个Ubuntu 16.04的环境，它是默认Qt4的。

脚本用法：在启动客户端之后

```Shell
script run amiibo load <path to your amiibo>.bin [-k <path to your retail key>.bin]
```

如果预先将``.bin``的密钥文件放入了``/client``下并且命名为``amiitool_keys.bin``则无需指定``-k``参数。执行命令之后，Proxmark3会直接开始模拟，此时便可以完全正常的使用。

### 自己改造3DS的充电接口

3DS的原装充电接口是一种很特殊的接口，因为我从来没有在别的设备上见过，所以无法准确说出它的官方名称，如果有知道的可以联系我或者评论。这样就导致平时需要多带一个充电线/充电器。但是这个问题还有一个解决方案，那就是自己更换或另装一个新的充电接口。如果你希望更换并且尽量减少工程量，可以将接口换成Micro-USB接口；或者，也可以在附近另外安装一个新的接口。

改造充电接口是所有硬件改机中最容易的。将3DS后盖拆开，取出电池并取下螺丝。这时第二个后盖应该也已经松动，轻轻地取下这个后盖并收好螺丝，有的机型的这个后盖有连接线将其连在机体上，用指甲或螺丝刀轻轻地挑开即可。此时3DS的PCB板应该已经完全暴露。在动手拆除充电接口之前，先不要着急，将充电线连接好并开始充电，此时用万用表检测焊点电压就可以分清楚正负连接线。之后的改机过程就全凭自己发挥了，是换掉还是另开一个口，换成什么，都随意，因为3DS也是5V的标准充电电压，所以无需费神考虑升降压问题。

但是需要注意的是，最好在完成之后先检查有无短路再准备测试插电，同时对暴露的焊点/飞线进行绝缘，简单地涂上一点热熔胶即可，当然绝缘涂层之类也没有问题。最后，**我没有查到3DS的满电停充机制的运作方法，尚不明确是否需要原装充电器才可以，在改机之后最好注意一下充电时间和温度，以免意外发生**。

### R4烧录卡的使用
